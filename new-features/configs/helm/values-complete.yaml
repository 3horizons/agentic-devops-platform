# Red Hat Developer Hub Helm Chart Values - Complete (MCP + Lightspeed)

nameOverride: rhdh
fullnameOverride: rhdh

# Image Configuration
image:
  repository: quay.io/rhdh/rhdh
  tag: "1.2.0"
  pullPolicy: IfNotPresent

# Replication
replicaCount: 2

# Service Configuration
service:
  type: ClusterIP
  port: 7007
  targetPort: 7007

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/rate-limit: "100"
  hosts:
    - host: rhdh.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: rhdh-tls
      hosts:
        - rhdh.example.com

# Resources
resources:
  requests:
    memory: "4Gi"
    cpu: "2000m"
  limits:
    memory: "8Gi"
    cpu: "4000m"

# Node Selection for affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - rhdh
          topologyKey: kubernetes.io/hostname

# Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  fsGroup: 1001
  capabilities:
    drop:
      - ALL

# Database Configuration (PostgreSQL)
postgresql:
  enabled: true
  auth:
    username: rhdh
    password: changeme
    database: rhdh
  primary:
    resources:
      requests:
        memory: "2Gi"
        cpu: "1000m"
    persistence:
      enabled: true
      size: 100Gi
      storageClassName: default
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true

# OIDC Configuration
oidc:
  issuer: "https://keycloak.example.com/auth/realms/rhdh"
  clientId: "rhdh"
  clientSecret: ""

# RBAC Configuration
rbac:
  enabled: true
  policyFile: /etc/config/permission-policies-ai.csv
  cache:
    enabled: true
    ttl: 3600

# Dynamic Plugins
dynamicPlugins:
  enabled: true
  configFile: /etc/config/dynamic-plugins.yaml

# All MCP Plugins Enabled
mcp:
  filesystem:
    enabled: true
    rootPath: /workspace
    allowedPaths:
      - /workspace/**
      - /tmp/**
    readOnly: false

  git:
    enabled: true
    allowedRepositories:
      - "https://github.com/**"
    timeout: 30000

  kubernetes:
    enabled: true
    kubeConfig: /etc/kubeconfig/config
    allowedNamespaces:
      - "*"

  github:
    enabled: true
    baseUrl: "https://api.github.com"
    allowedOrganizations:
      - "*"

# Lightspeed Stack Configuration
lightspeed:
  enabled: true

  # Lightspeed Chat Service
  lcs:
    enabled: true
    endpoint: "http://lcs-service:8080"
    authType: oidc
    conversationHistoryLimit: 50
    conversationRetentionDays: 90
    streaming: true
    rateLimit:
      requestsPerMinute: 100
      tokensPerMinute: 500000

  # Llama Stack
  llamaStack:
    enabled: true
    endpoint: "http://llama-stack:8000"
    byom:
      provider: azure-openai
      azureOpenAI:
        apiKey: ""
        endpoint: ""
        deployment: "gpt-4-turbo"
        apiVersion: "2024-08-01-preview"

  # RAG Engine
  rag:
    enabled: true
    endpoint: "http://rag-engine-service:8090"
    vectorDb:
      type: milvus
      milvus:
        host: milvus-service
        port: 19530
        database: default
        collection: rhdh_documents
    chunkSize: 1024
    chunkOverlap: 128
    topK: 5

# Caching Configuration
cache:
  enabled: true
  type: redis
  url: "redis://redis:6379"
  ttl: 3600
  maxSize: 2147483648  # 2GB

# Storage Configuration
storage:
  enabled: true
  type: s3
  s3:
    bucket: rhdh-artifacts
    region: us-east-1
    credentials: aws

# Monitoring & Observability
monitoring:
  enabled: true
  prometheus:
    enabled: true
    port: 9090
    serviceMonitor:
      enabled: true
  jaeger:
    enabled: true
    endpoint: "http://jaeger:6831"
  loki:
    enabled: true
    endpoint: "http://loki:3100"

# Feature Flags
featureFlags:
  dynamicPluginsEnabled: true
  rbacEnabled: true
  lightspeedEnabled: true
  conversationHistoryEnabled: true
  ragEnabled: true
  streamingEnabled: true
  monitoringEnabled: true

# Environment Variables
env:
  - name: NODE_ENV
    value: production
  - name: LOG_LEVEL
    value: info
  - name: BYOM_PROVIDER
    value: azure-openai
  - name: AZURE_OPENAI_API_KEY
    valueFrom:
      secretKeyRef:
        name: llama-stack-byom
        key: AZURE_OPENAI_API_KEY
        optional: true
  - name: AZURE_OPENAI_ENDPOINT
    valueFrom:
      secretKeyRef:
        name: llama-stack-byom
        key: AZURE_OPENAI_ENDPOINT
        optional: true
  - name: GITHUB_TOKEN
    valueFrom:
      secretKeyRef:
        name: mcp-github-token
        key: token
  - name: OIDC_ISSUER
    valueFrom:
      secretKeyRef:
        name: rhdh-oidc
        key: issuer
  - name: OIDC_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: rhdh-oidc
        key: clientId
  - name: OIDC_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: rhdh-oidc
        key: clientSecret
  - name: REDIS_URL
    value: "redis://redis:6379"
  - name: DB_HOST
    value: "postgresql"
  - name: DB_PORT
    value: "5432"
  - name: DB_USER
    value: "rhdh"
  - name: DB_NAME
    value: "rhdh"
  - name: DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: postgresql
        key: password

# Volume Mounts
volumeMounts:
  - name: config
    mountPath: /etc/config
  - name: kubeconfig
    mountPath: /etc/kubeconfig
    readOnly: true

# Volumes
volumes:
  - name: config
    configMap:
      name: rhdh-dynamic-plugins
  - name: kubeconfig
    secret:
      secretName: kubeconfig
      optional: true

# Health Checks
livenessProbe:
  httpGet:
    path: /health
    port: 7007
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /.well-known/openid-configuration
    port: 7007
  initialDelaySeconds: 30
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health
    port: 7007
  initialDelaySeconds: 0
  periodSeconds: 5
  failureThreshold: 40

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Horizontal Pod Autoscaler
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Network Policy
networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: rhdh
      ports:
        - protocol: TCP
          port: 7007
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
        - protocol: TCP
          port: 19530  # Milvus
        - protocol: TCP
          port: 8080  # LCS, Llama Stack
        - protocol: TCP
          port: 8090  # RAG Engine

# Service Account
serviceAccount:
  create: true
  automountServiceAccountToken: true
  name: ""

# App Configuration
appConfig: |
  app:
    title: Red Hat Developer Hub
    baseUrl: https://rhdh.example.com

  backend:
    baseUrl: https://rhdh.example.com
    listen:
      port: 7007
    csp:
      connect-src:
        - "'self'"
        - 'https:'
        - 'ws://localhost:8080'
        - 'http://lcs-service:8080'

  auth:
    providers:
      oidc:
        development:
          metadataUrl: '${OIDC_ISSUER}/.well-known/openid-configuration'
          clientId: '${OIDC_CLIENT_ID}'
          clientSecret: '${OIDC_CLIENT_SECRET}'

  integrations:
    github:
      - host: github.com
        token: '${GITHUB_TOKEN}'

  lightspeed:
    chat:
      endpoint: 'http://lcs-service:8080'
      authType: oidc

  rbac:
    enabled: true
    policyFile: /etc/config/permission-policies-ai.csv

  prometheus:
    enabled: true
    port: 9090

# Termination Grace Period
terminationGracePeriodSeconds: 30

# Update Strategy
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0
