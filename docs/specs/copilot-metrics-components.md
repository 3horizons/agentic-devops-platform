# Copilot Metrics Plugin — Component Specifications

> Generated by `@rhdh-architect` | References: portal-gap-analysis.md (§12), ADR-003-copilot-metrics-plugin.md

---

## Plugin: `@internal/plugin-copilot-metrics`

| Campo | Valor |
|-------|-------|
| **Package** | `@internal/plugin-copilot-metrics` |
| **Route** | `/copilot-metrics` |
| **Export** | `CopilotMetricsPage` |
| **Sidebar** | icon: `AssessmentIcon`, text: "Copilot Metrics" |
| **Type** | Full-stack (frontend + backend proxy) |
| **Data Source** | GitHub REST API via Backstage Proxy (`/api/proxy/github-copilot`) |

### Proxy Configuration (app-config.yaml)

```yaml
proxy:
  endpoints:
    /github-copilot:
      target: https://api.github.com
      headers:
        Authorization: Bearer ${GITHUB_COPILOT_TOKEN}
        Accept: application/vnd.github+json
        X-GitHub-Api-Version: "2022-11-28"
      changeOrigin: true
      pathRewrite:
        "^/api/proxy/github-copilot": ""
```

### Wiring (dynamic-plugins-config.yaml)

```yaml
dynamicPlugins:
  frontend:
    "@internal/plugin-copilot-metrics":
      dynamicRoutes:
        - path: /copilot-metrics
          importName: CopilotMetricsPage
          menuItem:
            icon: AssessmentIcon
            text: Copilot Metrics
```

---

## Component: CopilotMetricsPage

| Campo | Valor |
|-------|-------|
| **Purpose** | Top-level page container; orchestrates layout, error boundary, and data loading |
| **Data Sources** | None directly (delegates to child hooks) |
| **Backstage APIs** | None directly |
| **Wiring** | `dynamicRoutes: path=/copilot-metrics, importName=CopilotMetricsPage` |

**Props:**
```typescript
// No props — top-level routable extension
```

**Component Tree:**
```
<ErrorBoundary>
  <CopilotMetricsPage>
    <MetricsHeader />
    <Grid container spacing={3}>
      <Grid item xs={12} md={4}><ActiveUsersCard /></Grid>
      <Grid item xs={12} md={4}><SeatUtilization /></Grid>
      <Grid item xs={12} md={4}><AcceptanceRateChart /></Grid>
    </Grid>
    <Grid container spacing={3}>
      <Grid item xs={12} md={6}><LanguageBreakdown /></Grid>
      <Grid item xs={12} md={6}><IdeUsageChart /></Grid>
    </Grid>
    <Grid container spacing={3}>
      <Grid item xs={12} md={6}><ChatUsageStats /></Grid>
      <Grid item xs={12} md={6}><TeamComparison /></Grid>
    </Grid>
    <TrendSparklines />
  </CopilotMetricsPage>
</ErrorBoundary>
```

**Visual Requirements:**
- Background: `#FAFAFA` (light gray)
- Max-width: 1440px, centered
- Padding: 24px
- Responsive: stacks to single column on mobile

---

## Component: MetricsHeader

| Campo | Valor |
|-------|-------|
| **Purpose** | Display page title, date range picker, and manual refresh button |
| **Data Sources** | React state (date range) |
| **Backstage APIs** | None |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface MetricsHeaderProps {
  dateRange: DateRange;
  onDateRangeChange: (range: DateRange) => void;
  onRefresh: () => void;
  lastUpdated?: Date;
}

type DateRange = {
  since: string; // ISO date YYYY-MM-DD
  until: string; // ISO date YYYY-MM-DD
  label: '7d' | '14d' | '28d';
};
```

**Visual Requirements:**
- Title: "GitHub Copilot Metrics", 28px bold, `#1B1B1F`, Segoe UI
- Date range: 3 chip buttons (7 days, 14 days, 28 days), selected = `#0078D4` fill
- Refresh: `IconButton` with `RefreshIcon`
- Last updated: small timestamp text, `#999`
- Layout: title left, controls right (flexbox `space-between`)

---

## Component: ActiveUsersCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display total active users and engaged users with percentage |
| **Data Sources** | `useCopilotMetrics()` → `total_active_users`, `total_engaged_users` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface ActiveUsersCardProps {
  totalActive: number;
  totalEngaged: number;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#0078D4`
- Title: "Active Users", 14px bold, `#666`
- Total active: 42px bold, `#1B1B1F` (big number)
- Engaged users: secondary number with percentage badge
- Engagement rate: `(engaged/active * 100)%` in green if >70%, yellow if 40-70%, red if <40%

---

## Component: SeatUtilization

| Campo | Valor |
|-------|-------|
| **Purpose** | Display assigned vs. active Copilot seats as a gauge chart |
| **Data Sources** | `useCopilotBilling()` → `seat_breakdown.total`, `seat_breakdown.active_this_cycle` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface SeatUtilizationProps {
  assigned: number;
  active: number;
  inactive: number;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#7FBA00`
- Title: "Seat Utilization", 14px bold
- Gauge: semi-circle progress chart (recharts `PieChart` with `startAngle/endAngle`)
  - Fill: `#7FBA00` (active), `#E0E0E0` (unused)
- Center text: utilization percentage (e.g., "78%")
- Below gauge: "Assigned: X / Active: Y / Inactive: Z"

---

## Component: AcceptanceRateChart

| Campo | Valor |
|-------|-------|
| **Purpose** | Display suggestion acceptance rate over time as a line chart |
| **Data Sources** | `useCopilotMetrics()` → daily `suggestions_count`, `acceptances_count` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface AcceptanceRateChartProps {
  data: Array<{
    date: string;
    suggestionsCount: number;
    acceptancesCount: number;
    acceptanceRate: number; // percentage
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#00A4EF`
- Title: "Acceptance Rate", 14px bold
- Chart: `recharts.LineChart`, 280px height
  - Line 1: acceptance rate (%) in `#0078D4`, stroke width 2
  - Area fill: `#0078D4` with opacity 0.1
  - X-axis: dates (MMM DD format)
  - Y-axis: 0-100%
  - Tooltip: date, suggested, accepted, rate%
- Summary: "Avg: XX%" below chart

---

## Component: LanguageBreakdown

| Campo | Valor |
|-------|-------|
| **Purpose** | Display lines suggested and accepted per programming language |
| **Data Sources** | `useCopilotMetrics()` → `copilot_ide_code_completions.editors[].models[].languages[]` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface LanguageBreakdownProps {
  data: Array<{
    language: string;
    totalSuggestions: number;
    totalAcceptances: number;
    totalLinesSuggested: number;
    totalLinesAccepted: number;
    acceptanceRate: number;
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "Language Breakdown", 14px bold
- Layout: left = horizontal bar chart (top 10), right = data table
- Bar chart: `recharts.BarChart`, bars in `#0078D4` (suggested) and `#7FBA00` (accepted)
- Table columns: Language, Suggestions, Accepted, Lines Suggested, Lines Accepted, Rate%
- Table: sortable by any column, default sort by suggestions descending
- Use `<Table>` from `@backstage/core-components`

---

## Component: IdeUsageChart

| Campo | Valor |
|-------|-------|
| **Purpose** | Display Copilot usage distribution across IDEs/editors |
| **Data Sources** | `useCopilotMetrics()` → `copilot_ide_code_completions.editors[]` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface IdeUsageChartProps {
  data: Array<{
    editor: string;
    totalUsers: number;
    percentage: number;
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "IDE Usage", 14px bold
- Donut chart: `recharts.PieChart` with inner radius, 200px size
  - VS Code: `#0078D4`, JetBrains: `#F25022`, Neovim: `#7FBA00`, Other: `#FFB900`
- Legend: below chart, horizontal, editor name + count + percentage
- Center text: total unique users

---

## Component: ChatUsageStats

| Campo | Valor |
|-------|-------|
| **Purpose** | Display chat interaction statistics (IDE chat, Dotcom chat, PR summaries) |
| **Data Sources** | `useCopilotMetrics()` → `copilot_ide_chat`, `copilot_dotcom_chat`, `copilot_dotcom_pull_requests` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface ChatUsageStatsProps {
  ideChat: {
    totalTurns: number;
    totalAcceptances: number;
  };
  dotcomChat: {
    totalTurns: number;
  };
  pullRequests: {
    totalSummaries: number;
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "Chat & PR Usage", 14px bold
- Layout: 3 stat sub-cards in a row (reuse `StatCard` pattern)
  - IDE Chat (blue icon `ChatIcon`): "X turns, Y accepted"
  - Dotcom Chat (green icon `WebIcon`): "X turns"
  - PR Summaries (yellow icon `MergeTypeIcon`): "X summaries"
- Each sub-card: icon, big number, label

---

## Component: TeamComparison

| Campo | Valor |
|-------|-------|
| **Purpose** | Compare Copilot usage across teams within the organization |
| **Data Sources** | `useTeamMetrics(teamSlugs)` → per-team metrics |
| **Backstage APIs** | `fetchApiRef` (via hook), `configApiRef` (for team list) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface TeamComparisonProps {
  teams: Array<{
    slug: string;
    name: string;
    activeUsers: number;
    engagedUsers: number;
    acceptanceRate: number;
    totalSuggestions: number;
    totalAcceptances: number;
  }>;
  loading: boolean;
  error?: Error;
}
```

**Configuration (app-config.yaml):**
```yaml
copilotMetrics:
  org: my-github-org
  teams:
    - slug: platform-team
      name: Platform Team
    - slug: backend-team
      name: Backend Team
    - slug: frontend-team
      name: Frontend Team
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "Team Comparison", 14px bold
- Table: `<Table>` from `@backstage/core-components`
- Columns: Team Name, Active Users, Engaged Users, Acceptance Rate%, Total Suggestions
- Sortable by any column
- Acceptance rate cell: color-coded (green >70%, yellow 40-70%, red <40%)
- Row highlight on hover

---

## Component: TrendSparklines

| Campo | Valor |
|-------|-------|
| **Purpose** | Display 4 mini sparkline charts showing 28-day trends for key metrics |
| **Data Sources** | `useCopilotMetrics()` → aggregate daily values over 28 days |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `CopilotMetricsPage` |

**Props:**
```typescript
interface TrendSparklinesProps {
  trends: {
    activeUsers: number[];      // 28 daily values
    acceptanceRate: number[];   // 28 daily values (%)
    chatTurns: number[];        // 28 daily values
    linesSuggested: number[];   // 28 daily values
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Full-width section, 4 cards in a row (Grid: 4 columns)
- Each card: white, border-radius 12px, 120px height
- Title: metric name, 12px, `#666`
- Current value: 20px bold, `#1B1B1F`
- Sparkline: `recharts.LineChart`, 80px height, no axes, stroke `#0078D4`, stroke-width 1.5
- Change indicator: arrow up (green) or down (red) with % change from 28 days ago

---

## Data Fetching Hooks

### `useCopilotMetrics(dateRange: DateRange)`

```typescript
import { useApi, fetchApiRef } from '@backstage/core-plugin-api';
import useAsync from 'react-use/lib/useAsync';

interface CopilotMetricsDay {
  date: string;
  total_active_users: number;
  total_engaged_users: number;
  copilot_ide_code_completions: {
    total_engaged_users: number;
    editors: Array<{
      name: string;
      total_engaged_users: number;
      models: Array<{
        name: string;
        total_engaged_users: number;
        languages: Array<{
          name: string;
          total_engaged_users: number;
          total_code_suggestions: number;
          total_code_acceptances: number;
          total_code_lines_suggested: number;
          total_code_lines_accepted: number;
        }>;
      }>;
    }>;
  };
  copilot_ide_chat: {
    total_engaged_users: number;
    editors: Array<{
      name: string;
      total_engaged_users: number;
      models: Array<{
        name: string;
        total_turns: number;
        total_acceptances: number;
      }>;
    }>;
  };
  copilot_dotcom_chat: {
    total_engaged_users: number;
    models: Array<{
      name: string;
      total_turns: number;
    }>;
  };
  copilot_dotcom_pull_requests: {
    total_engaged_users: number;
    repositories: Array<{
      name: string;
      total_engaged_users: number;
      models: Array<{
        name: string;
        total_pr_summaries_created: number;
      }>;
    }>;
  };
}

export function useCopilotMetrics(dateRange: DateRange) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const response = await fetchApi.fetch(
      `/api/proxy/github-copilot/orgs/${org}/copilot/metrics?since=${dateRange.since}&until=${dateRange.until}`,
    );
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
    }
    const data: CopilotMetricsDay[] = await response.json();
    return data;
  }, [dateRange]);
}
```

### `useCopilotBilling()`

```typescript
interface CopilotBilling {
  seat_breakdown: {
    total: number;
    active_this_cycle: number;
    inactive_this_cycle: number;
    added_this_cycle: number;
  };
  seat_management_setting: string;
}

export function useCopilotBilling() {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const response = await fetchApi.fetch(
      `/api/proxy/github-copilot/orgs/${org}/copilot/billing`,
    );
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
    }
    const data: CopilotBilling = await response.json();
    return data;
  }, []);
}
```

### `useTeamMetrics(teams: TeamConfig[])`

```typescript
interface TeamConfig {
  slug: string;
  name: string;
}

export function useTeamMetrics(teams: TeamConfig[], dateRange: DateRange) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const results = await Promise.all(
      teams.map(async team => {
        const response = await fetchApi.fetch(
          `/api/proxy/github-copilot/orgs/${org}/team/${team.slug}/copilot/metrics?since=${dateRange.since}&until=${dateRange.until}`,
        );
        if (!response.ok) {
          return { ...team, metrics: null, error: response.statusText };
        }
        const metrics: CopilotMetricsDay[] = await response.json();
        return { ...team, metrics, error: null };
      }),
    );
    return results;
  }, [teams, dateRange]);
}
```

### `useDateRange()`

```typescript
import { useState, useCallback } from 'react';

export function useDateRange(defaultLabel: '7d' | '14d' | '28d' = '28d') {
  const [dateRange, setDateRange] = useState<DateRange>(() =>
    computeDateRange(defaultLabel),
  );

  const updateRange = useCallback((label: '7d' | '14d' | '28d') => {
    setDateRange(computeDateRange(label));
  }, []);

  return { dateRange, updateRange };
}

function computeDateRange(label: '7d' | '14d' | '28d'): DateRange {
  const until = new Date();
  const since = new Date();
  const days = label === '7d' ? 7 : label === '14d' ? 14 : 28;
  since.setDate(since.getDate() - days);
  return {
    since: since.toISOString().split('T')[0],
    until: until.toISOString().split('T')[0],
    label,
  };
}
```

---

## Color Constants (theme.ts)

```typescript
export const MS_COLORS = {
  blue: '#00A4EF',
  green: '#7FBA00',
  yellow: '#FFB900',
  red: '#F25022',
  darkBlue: '#0078D4',
  sidebarBg: '#1B1B1F',
} as const;

export const CHART_COLORS = [
  '#0078D4', // Primary blue
  '#F25022', // Red
  '#7FBA00', // Green
  '#FFB900', // Yellow
  '#00A4EF', // Light blue
  '#8661C5', // Purple
  '#E74856', // Coral
  '#00CC6A', // Teal
] as const;
```

---

## Plugin Structure Summary

```
plugins/copilot-metrics/
+-- package.json
+-- tsconfig.json
+-- src/
|   +-- plugin.ts                     # createPlugin + createRoutableExtension
|   +-- index.ts                      # barrel export: CopilotMetricsPage
|   +-- routes.ts                     # routeRef definitions
|   +-- theme.ts                      # MS_COLORS, CHART_COLORS
|   +-- components/
|   |   +-- CopilotMetricsPage.tsx    # Page container
|   |   +-- MetricsHeader.tsx         # Title + date range + refresh
|   |   +-- ActiveUsersCard.tsx       # Big-number active/engaged
|   |   +-- SeatUtilization.tsx       # Gauge chart
|   |   +-- AcceptanceRateChart.tsx   # Line chart
|   |   +-- LanguageBreakdown.tsx     # Table + bar chart
|   |   +-- IdeUsageChart.tsx         # Donut chart
|   |   +-- ChatUsageStats.tsx        # 3 stat sub-cards
|   |   +-- TeamComparison.tsx        # Sortable data table
|   |   +-- TrendSparklines.tsx       # 4 sparkline mini-charts
|   +-- hooks/
|   |   +-- useCopilotMetrics.ts      # GET /copilot/metrics
|   |   +-- useCopilotBilling.ts      # GET /copilot/billing
|   |   +-- useTeamMetrics.ts         # GET /team/{slug}/copilot/metrics
|   |   +-- useDateRange.ts           # Date range state
|   +-- api/
|       +-- types.ts                  # GitHub API response types
|       +-- copilotApiClient.ts       # fetchApiRef wrapper
+-- dev/
|   +-- index.tsx                     # Dev harness with mock data
+-- dist-dynamic/                     # Generated by export-dynamic-plugin
```

---

## Testing Strategy

```typescript
import { TestApiProvider } from '@backstage/test-utils';
import { fetchApiRef } from '@backstage/core-plugin-api';

const mockFetchApi = {
  fetch: jest.fn(),
};

// Mock successful metrics response
mockFetchApi.fetch.mockResolvedValueOnce({
  ok: true,
  json: async () => mockCopilotMetricsResponse,
});

render(
  <TestApiProvider apis={[[fetchApiRef, mockFetchApi]]}>
    <CopilotMetricsPage />
  </TestApiProvider>,
);
```

**Test cases:**
- Renders loading state while fetching
- Renders all 8 components with mock data
- Handles API error (403 rate limit, 404 not found)
- Date range changes trigger re-fetch
- Language table sorts correctly
- Sparkline trends calculate % change correctly
- Empty data (new org, no metrics yet) shows appropriate message

---

## RBAC Requirements

```csv
p, role:default/admin, copilot-metrics, read, allow
p, role:default/team-lead, copilot-metrics, read, allow
p, role:default/developer, copilot-metrics, read, deny
p, role:default/viewer, copilot-metrics, read, deny
```

> Apenas Admin e Team Lead devem visualizar métricas organizacionais do Copilot. Developers podem ter acesso a métricas do seu próprio time em futuras iterações.
