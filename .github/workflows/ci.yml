# .github/workflows/ci.yml
# Continuous Integration workflow for Three Horizons Accelerator

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  TF_VERSION: "1.5.0"
  GO_VERSION: "1.21"
  PYTHON_VERSION: "3.11"

jobs:
  # Job 1: Detect changed files
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      terraform: ${{ steps.changes.outputs.terraform }}
      kubernetes: ${{ steps.changes.outputs.kubernetes }}
      scripts: ${{ steps.changes.outputs.scripts }}
      docs: ${{ steps.changes.outputs.docs }}
      agents: ${{ steps.changes.outputs.agents }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect Changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            terraform:
              - 'terraform/**'
            kubernetes:
              - 'deploy/**'
              - 'golden-paths/**'
            scripts:
              - 'scripts/**'
            docs:
              - 'docs/**'
              - '*.md'
            agents:
              - 'agents/**'
              - '.github/agents/**'

  # Job 2: Terraform validation
  terraform-validate:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.terraform == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

      - name: TFSec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          working_directory: terraform
          soft_fail: false

  # Job 3: Kubernetes manifest validation
  kubernetes-validate:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.kubernetes == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes Manifests
        run: |
          find deploy golden-paths -name "*.yaml" -o -name "*.yml" | \
            grep -v "kustomization" | \
            xargs -I {} kubeconform -strict -summary {} || true

      - name: Validate Helm Charts
        run: |
          if [ -d "deploy/helm" ]; then
            helm lint deploy/helm/*
          fi

      - name: Kubesec Security Scan
        uses: controlplaneio/kubesec-action@v0.0.2
        with:
          input: deploy/

  # Job 4: Script linting
  scripts-lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: ./scripts
          severity: warning

      - name: Check Script Permissions
        run: |
          find scripts -name "*.sh" -type f | while read script; do
            if [[ ! -x "$script" ]]; then
              echo "Warning: $script is not executable"
            fi
          done

  # Job 5: Documentation linting
  docs-lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !**/node_modules/**

      - name: Check Links
        uses: lycheeverse/lychee-action@v1
        with:
          args: --verbose --no-progress './**/*.md'
          fail: false

  # Job 6: Agent spec validation
  agents-validate:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.agents == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Validate Agent Specs
        run: |
          echo "Validating agent specifications..."

          # Check for required frontmatter
          for agent in agents/**/*.md .github/agents/*.md; do
            if [ -f "$agent" ]; then
              if ! head -1 "$agent" | grep -q "^---"; then
                echo "Error: $agent missing YAML frontmatter"
                exit 1
              fi
            fi
          done

          echo "All agent specs are valid"

  # Job 7: Security scanning
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Gitleaks Secret Detection
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4

  # Job 8: Summary
  ci-summary:
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - terraform-validate
      - kubernetes-validate
      - scripts-lint
      - docs-lint
      - agents-validate
      - security-scan
    if: always()

    steps:
      - name: CI Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform-validate.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Kubernetes | ${{ needs.kubernetes-validate.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Scripts | ${{ needs.scripts-lint.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.docs-lint.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agents | ${{ needs.agents-validate.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
