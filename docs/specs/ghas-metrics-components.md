# GHAS Metrics Plugin — Component Specifications

> Generated by `@rhdh-architect` | References: portal-gap-analysis.md (§13), ADR-004-ghas-metrics-plugin.md

---

## Plugin: `@internal/plugin-ghas-metrics`

| Campo | Valor |
|-------|-------|
| **Package (frontend)** | `@internal/plugin-ghas-metrics` |
| **Package (backend)** | `@internal/plugin-ghas-metrics-backend` |
| **Route** | `/ghas-metrics` |
| **Export** | `GhasMetricsPage` |
| **Sidebar** | icon: `SecurityIcon`, text: "GHAS Metrics" |
| **Type** | Full-stack (frontend + backend proxy + backend aggregation) |
| **Data Sources** | GitHub REST API via Backstage Proxy (`/api/proxy/github-security`) + backend module (`/api/ghas-metrics`) |

### Proxy Configuration (app-config.yaml)

```yaml
proxy:
  endpoints:
    /github-security:
      target: https://api.github.com
      headers:
        Authorization: Bearer ${GITHUB_SECURITY_TOKEN}
        Accept: application/vnd.github+json
        X-GitHub-Api-Version: "2022-11-28"
      changeOrigin: true
      pathRewrite:
        "^/api/proxy/github-security": ""
```

### Organization Configuration (app-config.yaml)

```yaml
ghasMetrics:
  org: my-github-org
  # Repos a excluir da análise (forks, archived, etc.)
  excludeRepos:
    - archived-repo
    - fork-repo
  # Cache TTL em segundos (default: 600 = 10 min)
  cacheTtlSeconds: 600
```

### Wiring (dynamic-plugins-config.yaml)

```yaml
dynamicPlugins:
  frontend:
    "@internal/plugin-ghas-metrics":
      dynamicRoutes:
        - path: /ghas-metrics
          importName: GhasMetricsPage
          menuItem:
            icon: SecurityIcon
            text: GHAS Metrics
```

---

## Component: GhasMetricsPage

| Campo | Valor |
|-------|-------|
| **Purpose** | Top-level page container; orchestrates layout, error boundary, and data loading |
| **Data Sources** | None directly (delegates to child hooks) |
| **Backstage APIs** | None directly |
| **Wiring** | `dynamicRoutes: path=/ghas-metrics, importName=GhasMetricsPage` |

**Props:**
```typescript
// No props — top-level routable extension
```

**Component Tree:**
```
<ErrorBoundary>
  <GhasMetricsPage>
    <SecurityHeader />
    <Grid container spacing={3}>
      <Grid item xs={12} md={3}><CodeScanningCard /></Grid>
      <Grid item xs={12} md={3}><SecretScanningCard /></Grid>
      <Grid item xs={12} md={3}><DependabotAlertsCard /></Grid>
      <Grid item xs={12} md={3}><GhasCommittersCard /></Grid>
    </Grid>
    <Grid container spacing={3}>
      <Grid item xs={12} md={6}><SecurityTrendChart /></Grid>
      <Grid item xs={12} md={6}><SeverityBreakdown /></Grid>
    </Grid>
    <Grid container spacing={3}>
      <Grid item xs={12} md={6}><MttrMetrics /></Grid>
      <Grid item xs={12} md={6}><PushProtectionCard /></Grid>
    </Grid>
    <RepoCoverageTable />
  </GhasMetricsPage>
</ErrorBoundary>
```

**Visual Requirements:**
- Background: `#FAFAFA` (light gray)
- Max-width: 1440px, centered
- Padding: 24px
- Responsive: stacks to single column on mobile

---

## Component: SecurityHeader

| Campo | Valor |
|-------|-------|
| **Purpose** | Display page title, date range picker, severity filter, and refresh button |
| **Data Sources** | React state (date range, severity filter) |
| **Backstage APIs** | None |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface SecurityHeaderProps {
  dateRange: DateRange;
  onDateRangeChange: (range: DateRange) => void;
  severityFilter: SeverityFilter;
  onSeverityFilterChange: (filter: SeverityFilter) => void;
  onRefresh: () => void;
  lastUpdated?: Date;
}

type DateRange = {
  since: string; // ISO date YYYY-MM-DD
  until: string; // ISO date YYYY-MM-DD
  label: '7d' | '14d' | '28d' | '90d';
};

type SeverityFilter = {
  critical: boolean;
  high: boolean;
  medium: boolean;
  low: boolean;
};
```

**Visual Requirements:**
- Title: "GitHub Advanced Security Metrics", 28px bold, `#1B1B1F`, Segoe UI
- Date range: 4 chip buttons (7d, 14d, 28d, 90d), selected = `#0078D4` fill
- Severity filter: 4 toggle chips (Critical=red, High=orange, Medium=yellow, Low=green)
- Refresh: `IconButton` with `RefreshIcon`
- Last updated: small timestamp text, `#999`
- Layout: title left, controls right (flexbox `space-between`)

---

## Component: CodeScanningCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display open code scanning alerts grouped by severity |
| **Data Sources** | `useCodeScanningAlerts()` → aggregated alert counts |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface CodeScanningCardProps {
  openAlerts: number;
  fixedThisPeriod: number;
  bySeverity: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#D32F2F` (alert red)
- Header: `ShieldIcon` + "Code Scanning"
- Big number: total open alerts, 36px bold
- Severity badges: inline row of colored chips
  - Critical: `#D32F2F`, High: `#F57C00`, Medium: `#FFB900`, Low: `#7FBA00`
- Fixed this period: small green text "+X fixed"

---

## Component: SecretScanningCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display secret scanning alert summary with remediation status |
| **Data Sources** | `useSecretScanningAlerts()` → aggregated counts |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface SecretScanningCardProps {
  openSecrets: number;
  resolvedCount: number;
  byValidity: {
    valid: number;     // Confirmed leaked secrets
    invalid: number;   // False positives
    unknown: number;   // Not checked
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#F57C00` (warning orange)
- Header: `VpnKeyIcon` + "Secret Scanning"
- Big number: open secrets, 36px bold
- Validity breakdown: 3 small badges (Valid=red, Invalid=gray, Unknown=yellow)
- Resolved: small green text "+X resolved"
- Valid secrets highlighted with red emphasis (requires immediate action)

---

## Component: DependabotAlertsCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display aggregated Dependabot vulnerability alerts by severity and ecosystem |
| **Data Sources** | `useDependabotSummary()` → backend aggregation |
| **Backstage APIs** | `fetchApiRef` (via hook to backend module) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface DependabotAlertsCardProps {
  totalOpen: number;
  bySeverity: {
    critical: number;
    high: number;
    medium: number;
    low: number;
  };
  byEcosystem: Array<{
    ecosystem: string;  // npm, pip, maven, nuget, go, etc.
    count: number;
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#FFB900` (yellow)
- Header: `BugReportIcon` + "Dependabot Alerts"
- Big number: total open vulnerabilities, 36px bold
- Severity badges: inline colored chips (same palette as CodeScanningCard)
- Ecosystem breakdown: small horizontal bar chart or pill list (top 5 ecosystems)
- Critical count: highlighted in red if > 0

---

## Component: GhasCommittersCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display GHAS active committers vs. maximum allowed (billing/licensing) |
| **Data Sources** | `useGhasBilling()` → `total_advanced_security_committers`, `maximum_advanced_security_committers` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface GhasCommittersCardProps {
  activeCommitters: number;
  maxCommitters: number;
  utilizationPercent: number;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, border-top 3px `#7FBA00` (green)
- Header: `PeopleIcon` + "GHAS Committers"
- Big number: active committers, 36px bold
- Progress bar: active/max ratio
  - Green if <70%, yellow if 70-90%, red if >90%
- Text below: "X of Y committers (Z%)"

---

## Component: SecurityTrendChart

| Campo | Valor |
|-------|-------|
| **Purpose** | Display alerts opened vs. closed over time as an area chart |
| **Data Sources** | `useCodeScanningAlerts()` + `useSecretScanningAlerts()` → daily aggregation by `created_at`/`fixed_at` |
| **Backstage APIs** | `fetchApiRef` (via hooks) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface SecurityTrendChartProps {
  data: Array<{
    date: string;
    opened: number;
    closed: number;
    netOpen: number; // cumulative open
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, full height
- Title: "Security Trend", 14px bold
- Chart: `recharts.AreaChart`, 300px height
  - Area 1 (opened): `#F25022` (red) with opacity 0.3
  - Area 2 (closed): `#7FBA00` (green) with opacity 0.3
  - Line: net open trend in `#0078D4`, dashed
- X-axis: dates (MMM DD)
- Y-axis: alert count
- Tooltip: date, opened, closed, net open
- Legend: Opened (red), Closed (green), Net Open (blue)

---

## Component: SeverityBreakdown

| Campo | Valor |
|-------|-------|
| **Purpose** | Display severity distribution of all open alerts as a donut chart |
| **Data Sources** | `useCodeScanningAlerts()` → grouped by `rule.security_severity_level` |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface SeverityBreakdownProps {
  data: Array<{
    severity: 'critical' | 'high' | 'medium' | 'low';
    count: number;
    percentage: number;
  }>;
  totalAlerts: number;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow, full height
- Title: "Severity Breakdown", 14px bold
- Chart: `recharts.PieChart` donut (inner radius 60%), 250px
  - Critical: `#D32F2F`, High: `#F57C00`, Medium: `#FFB900`, Low: `#7FBA00`
- Center text: total alert count
- Legend table below: severity, count, percentage
- Each legend row has a colored dot matching the chart

---

## Component: MttrMetrics

| Campo | Valor |
|-------|-------|
| **Purpose** | Display Mean Time To Remediate per alert type with trend indicators |
| **Data Sources** | `useMttrMetrics()` → backend computed MTTR |
| **Backstage APIs** | `fetchApiRef` (via hook to backend module) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface MttrMetricsProps {
  codeScanningMttr: {
    hours: number;
    displayValue: string; // "2.5 days" or "18 hours"
    trend: 'improving' | 'degrading' | 'stable';
    changePercent: number;
  };
  secretScanningMttr: {
    hours: number;
    displayValue: string;
    trend: 'improving' | 'degrading' | 'stable';
    changePercent: number;
  };
  dependabotMttr: {
    hours: number;
    displayValue: string;
    trend: 'improving' | 'degrading' | 'stable';
    changePercent: number;
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "Mean Time To Remediate (MTTR)", 14px bold
- Layout: 3 stat sub-cards in a row
  - Code Scanning MTTR: `ShieldIcon`, value in hours/days
  - Secret Scanning MTTR: `VpnKeyIcon`, value in hours/days
  - Dependabot MTTR: `BugReportIcon`, value in hours/days
- Each sub-card shows:
  - Big number (displayValue)
  - Trend arrow: ↓ green (improving), ↑ red (degrading), → gray (stable)
  - Change percent badge
- Color-coded: green if MTTR < 24h, yellow if 24h-72h, red if > 72h

---

## Component: PushProtectionCard

| Campo | Valor |
|-------|-------|
| **Purpose** | Display push protection bypass statistics and blocked secret pushes |
| **Data Sources** | `useSecretScanningAlerts()` → filter by push protection events |
| **Backstage APIs** | `fetchApiRef` (via hook) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface PushProtectionCardProps {
  blockedCount: number;     // Pushes blocked by push protection
  bypassCount: number;      // Pushes that bypassed protection
  bypassReasons: Array<{
    reason: string;          // "false_positive", "used_in_tests", "will_fix_later"
    count: number;
  }>;
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Card: white, border-radius 12px, box-shadow
- Title: "Push Protection", 14px bold
- Layout: split view
  - Left: two big numbers stacked
    - Blocked: big green number with `BlockIcon`
    - Bypassed: big orange number with `WarningIcon`
  - Right: bypass reasons mini-table
    - Columns: Reason, Count
    - Sortable by count
- Success rate: "(blocked / (blocked + bypassed)) * 100%" displayed as a percentage badge

---

## Component: RepoCoverageTable

| Campo | Valor |
|-------|-------|
| **Purpose** | Show which repositories have GHAS features enabled and open alert counts |
| **Data Sources** | `useGhasBilling()` → per-repo breakdown + `useGhasSummary()` → alert counts |
| **Backstage APIs** | `fetchApiRef` (via hooks) |
| **Wiring** | Child of `GhasMetricsPage` |

**Props:**
```typescript
interface RepoCoverageTableProps {
  repos: Array<{
    name: string;
    codeScanning: boolean;
    secretScanning: boolean;
    dependabot: boolean;
    pushProtection: boolean;
    openAlerts: number;
    committers: number;
  }>;
  coverageSummary: {
    totalRepos: number;
    fullyEnabled: number;     // All 4 features enabled
    partiallyEnabled: number;
    notEnabled: number;
    coveragePercent: number;  // fullyEnabled / totalRepos * 100
  };
  loading: boolean;
  error?: Error;
}
```

**Visual Requirements:**
- Full-width card: white, border-radius 12px, box-shadow
- Title: "Repository Coverage", 14px bold
- Coverage summary bar: colored progress bar
  - Green segment: fully enabled repos
  - Yellow segment: partially enabled
  - Gray segment: not enabled
  - Text: "X of Y repositories (Z%) fully covered"
- Table: `<Table>` from `@backstage/core-components`
- Columns:
  | Column | Type |
  |--------|------|
  | Repository | Text (link to GitHub) |
  | Code Scanning | ✓ green / ✗ red |
  | Secret Scanning | ✓ green / ✗ red |
  | Dependabot | ✓ green / ✗ red |
  | Push Protection | ✓ green / ✗ red |
  | Open Alerts | Number (red if > 0) |
  | Committers | Number |
- Sortable by any column
- Filterable: show only repos with gaps
- Paginated: 25 repos per page

---

## Data Fetching Hooks

### `useCodeScanningAlerts(dateRange: DateRange)`

```typescript
import { useApi, fetchApiRef } from '@backstage/core-plugin-api';
import useAsync from 'react-use/lib/useAsync';

interface CodeScanningAlert {
  number: number;
  state: 'open' | 'closed' | 'dismissed' | 'fixed';
  rule: {
    id: string;
    severity: string;
    security_severity_level: 'critical' | 'high' | 'medium' | 'low';
    description: string;
  };
  tool: { name: string };
  created_at: string;
  fixed_at: string | null;
  dismissed_at: string | null;
  html_url: string;
}

export function useCodeScanningAlerts(org: string, dateRange: DateRange) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const alerts: CodeScanningAlert[] = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
      const response = await fetchApi.fetch(
        `/api/proxy/github-security/orgs/${encodeURIComponent(org)}/code-scanning/alerts?state=open&per_page=100&page=${page}`,
      );
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
      }
      const batch: CodeScanningAlert[] = await response.json();
      alerts.push(...batch);
      hasMore = batch.length === 100;
      page++;
    }

    return alerts;
  }, [org, dateRange]);
}
```

### `useSecretScanningAlerts(dateRange: DateRange)`

```typescript
interface SecretScanningAlert {
  number: number;
  state: 'open' | 'resolved';
  secret_type: string;
  secret_type_display_name: string;
  validity: 'active' | 'inactive' | 'unknown';
  resolution: string | null;
  created_at: string;
  resolved_at: string | null;
  push_protection_bypassed: boolean;
  push_protection_bypassed_at: string | null;
  push_protection_bypassed_by: { login: string } | null;
  html_url: string;
}

export function useSecretScanningAlerts(org: string, dateRange: DateRange) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const alerts: SecretScanningAlert[] = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
      const response = await fetchApi.fetch(
        `/api/proxy/github-security/orgs/${encodeURIComponent(org)}/secret-scanning/alerts?state=open&per_page=100&page=${page}`,
      );
      if (!response.ok) {
        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
      }
      const batch: SecretScanningAlert[] = await response.json();
      alerts.push(...batch);
      hasMore = batch.length === 100;
      page++;
    }

    return alerts;
  }, [org, dateRange]);
}
```

### `useDependabotSummary()`

```typescript
interface DependabotSummary {
  totalOpen: number;
  bySeverity: Record<string, number>;
  byEcosystem: Array<{ ecosystem: string; count: number }>;
}

export function useDependabotSummary(org: string) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const response = await fetchApi.fetch(
      `/api/ghas-metrics/org/${encodeURIComponent(org)}/dependabot`,
    );
    if (!response.ok) {
      throw new Error(`Backend API error: ${response.status} ${response.statusText}`);
    }
    const data: DependabotSummary = await response.json();
    return data;
  }, [org]);
}
```

### `useGhasBilling()`

```typescript
interface GhasBilling {
  total_advanced_security_committers: number;
  maximum_advanced_security_committers: number;
  purchased_advanced_security_committers: number;
  repositories: Array<{
    name: string;
    advanced_security_committers: number;
    advanced_security_committers_breakdown: Array<{
      user_login: string;
      last_pushed_date: string;
    }>;
  }>;
}

export function useGhasBilling(org: string) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const response = await fetchApi.fetch(
      `/api/proxy/github-security/orgs/${encodeURIComponent(org)}/settings/billing/advanced-security`,
    );
    if (!response.ok) {
      throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
    }
    const data: GhasBilling = await response.json();
    return data;
  }, [org]);
}
```

### `useMttrMetrics(dateRange: DateRange)`

```typescript
interface MttrResponse {
  code_scanning_mttr_hours: number;
  secret_scanning_mttr_hours: number;
  dependabot_mttr_hours: number;
  code_scanning_trend: 'improving' | 'degrading' | 'stable';
  secret_scanning_trend: 'improving' | 'degrading' | 'stable';
  dependabot_trend: 'improving' | 'degrading' | 'stable';
  code_scanning_change_percent: number;
  secret_scanning_change_percent: number;
  dependabot_change_percent: number;
}

export function useMttrMetrics(org: string, dateRange: DateRange) {
  const fetchApi = useApi(fetchApiRef);

  return useAsync(async () => {
    const response = await fetchApi.fetch(
      `/api/ghas-metrics/org/${encodeURIComponent(org)}/mttr?since=${dateRange.since}&until=${dateRange.until}`,
    );
    if (!response.ok) {
      throw new Error(`Backend API error: ${response.status} ${response.statusText}`);
    }
    const data: MttrResponse = await response.json();
    return data;
  }, [org, dateRange]);
}
```

---

## Backend Plugin Module

### Structure

```
plugins/ghas-metrics-backend/
+-- package.json
+-- tsconfig.json
+-- src/
|   +-- plugin.ts                 # createBackendPlugin
|   +-- router.ts                 # Express router
|   +-- service/
|   |   +-- GhasAggregator.ts     # Main aggregation orchestrator
|   |   +-- MttrCalculator.ts     # MTTR computation logic
|   |   +-- RepoScanner.ts       # Iterates org repos for Dependabot
|   |   +-- PaginationHelper.ts  # GitHub API pagination handler
|   |   +-- CacheManager.ts      # In-memory cache with TTL
|   +-- types.ts                  # TypeScript interfaces
```

### Router Endpoints

```typescript
// router.ts
import { Router } from 'express';

export async function createRouter(options: RouterOptions): Promise<Router> {
  const router = Router();
  const aggregator = new GhasAggregator(options.config, options.logger);

  // GET /api/ghas-metrics/org/:org/summary
  router.get('/org/:org/summary', async (req, res) => {
    const { org } = req.params;
    const summary = await aggregator.getOrgSummary(org);
    res.json(summary);
  });

  // GET /api/ghas-metrics/org/:org/dependabot
  router.get('/org/:org/dependabot', async (req, res) => {
    const { org } = req.params;
    const dependabot = await aggregator.getDependabotSummary(org);
    res.json(dependabot);
  });

  // GET /api/ghas-metrics/org/:org/mttr
  router.get('/org/:org/mttr', async (req, res) => {
    const { org } = req.params;
    const since = typeof req.query.since === 'string' ? req.query.since : undefined;
    const until = typeof req.query.until === 'string' ? req.query.until : undefined;
    const mttr = await aggregator.getMttrMetrics(org, since, until);
    res.json(mttr);
  });

  return router;
}
```

### MTTR Calculation Logic

```typescript
// service/MttrCalculator.ts

interface AlertTimestamps {
  created_at: string;
  fixed_at: string | null;
}

export function calculateMttr(alerts: AlertTimestamps[]): number {
  const fixedAlerts = alerts.filter(a => a.fixed_at !== null);
  if (fixedAlerts.length === 0) return 0;

  const totalHours = fixedAlerts.reduce((sum, alert) => {
    const created = new Date(alert.created_at).getTime();
    const fixed = new Date(alert.fixed_at!).getTime();
    const diffHours = (fixed - created) / (1000 * 60 * 60);
    return sum + diffHours;
  }, 0);

  return totalHours / fixedAlerts.length;
}

export function formatMttr(hours: number): string {
  if (hours < 1) return `${Math.round(hours * 60)} min`;
  if (hours < 24) return `${hours.toFixed(1)} hours`;
  return `${(hours / 24).toFixed(1)} days`;
}

export function computeTrend(
  currentMttr: number,
  previousMttr: number,
): { trend: 'improving' | 'degrading' | 'stable'; changePercent: number } {
  if (previousMttr === 0) return { trend: 'stable', changePercent: 0 };
  const change = ((currentMttr - previousMttr) / previousMttr) * 100;
  if (Math.abs(change) < 5) return { trend: 'stable', changePercent: change };
  return {
    trend: change < 0 ? 'improving' : 'degrading',
    changePercent: change,
  };
}
```

---

## Color Constants (theme.ts)

```typescript
export const MS_COLORS = {
  blue: '#00A4EF',
  green: '#7FBA00',
  yellow: '#FFB900',
  red: '#F25022',
  darkBlue: '#0078D4',
  sidebarBg: '#1B1B1F',
} as const;

export const SEVERITY_COLORS = {
  critical: '#D32F2F',
  high: '#F57C00',
  medium: '#FFB900',
  low: '#7FBA00',
  info: '#00A4EF',
} as const;

export const TREND_COLORS = {
  improving: '#7FBA00',
  degrading: '#D32F2F',
  stable: '#999999',
} as const;
```

---

## Frontend Plugin Structure Summary

```
plugins/ghas-metrics/
+-- package.json
+-- tsconfig.json
+-- src/
|   +-- plugin.ts                     # createPlugin + createRoutableExtension
|   +-- index.ts                      # barrel export: GhasMetricsPage
|   +-- routes.ts                     # routeRef definitions
|   +-- theme.ts                      # MS_COLORS, SEVERITY_COLORS, TREND_COLORS
|   +-- components/
|   |   +-- GhasMetricsPage.tsx       # Page container
|   |   +-- SecurityHeader.tsx        # Title + date + severity filter
|   |   +-- CodeScanningCard.tsx      # Open alerts by severity
|   |   +-- SecretScanningCard.tsx    # Secret alerts + validity
|   |   +-- DependabotAlertsCard.tsx  # Vulnerabilities by ecosystem
|   |   +-- GhasCommittersCard.tsx    # Active committers gauge
|   |   +-- SecurityTrendChart.tsx    # Opened vs. closed area chart
|   |   +-- SeverityBreakdown.tsx     # Donut chart: severity distribution
|   |   +-- MttrMetrics.tsx           # MTTR per alert type
|   |   +-- PushProtectionCard.tsx    # Bypass stats
|   |   +-- RepoCoverageTable.tsx     # GHAS enablement per repo
|   +-- hooks/
|   |   +-- useCodeScanningAlerts.ts  # Paginated code scanning
|   |   +-- useSecretScanningAlerts.ts # Paginated secret scanning
|   |   +-- useDependabotSummary.ts   # Backend aggregation
|   |   +-- useGhasBilling.ts         # GHAS billing endpoint
|   |   +-- useGhasSummary.ts         # Backend summary
|   |   +-- useMttrMetrics.ts         # Backend MTTR
|   |   +-- useDateRange.ts           # Date range state
|   +-- api/
|       +-- types.ts                  # All TypeScript interfaces
|       +-- ghasApiClient.ts          # fetchApiRef wrapper
+-- dev/
|   +-- index.tsx                     # Dev harness with mock data
+-- dist-dynamic/                     # Generated by export-dynamic-plugin
```

---

## Testing Strategy

```typescript
import { TestApiProvider } from '@backstage/test-utils';
import { fetchApiRef } from '@backstage/core-plugin-api';

const mockFetchApi = {
  fetch: jest.fn(),
};

// Mock code scanning response
mockFetchApi.fetch.mockImplementation((url: string) => {
  if (url.includes('code-scanning')) {
    return Promise.resolve({
      ok: true,
      json: async () => mockCodeScanningAlerts,
    });
  }
  if (url.includes('secret-scanning')) {
    return Promise.resolve({
      ok: true,
      json: async () => mockSecretScanningAlerts,
    });
  }
  if (url.includes('ghas-metrics') && url.includes('dependabot')) {
    return Promise.resolve({
      ok: true,
      json: async () => mockDependabotSummary,
    });
  }
  if (url.includes('billing/advanced-security')) {
    return Promise.resolve({
      ok: true,
      json: async () => mockGhasBilling,
    });
  }
  if (url.includes('mttr')) {
    return Promise.resolve({
      ok: true,
      json: async () => mockMttrResponse,
    });
  }
  return Promise.resolve({ ok: false, status: 404 });
});

render(
  <TestApiProvider apis={[[fetchApiRef, mockFetchApi]]}>
    <GhasMetricsPage />
  </TestApiProvider>,
);
```

**Test cases — Frontend:**
- Renders loading state while fetching
- Renders all 9 components with mock data
- Handles API error (403 rate limit, 404 not found)
- Date range changes trigger re-fetch
- Severity filter toggles filter the displayed data
- Donut chart renders correct proportions
- MTTR trend arrows display correct direction
- RepoCoverageTable pagination works
- Empty org (zero alerts) shows appropriate message

**Test cases — Backend:**
- MTTR calculation with mixed alerts (open + fixed)
- MTTR calculation with zero fixed alerts returns 0
- Dependabot aggregation across 0, 1, 50 repos
- Pagination helper follows Link headers correctly
- Cache returns cached data within TTL
- Cache refreshes after TTL expiry
- Rate limit (403) handling with retry-after

---

## RBAC Requirements

```csv
p, role:default/admin, ghas-metrics, read, allow
p, role:default/security-team, ghas-metrics, read, allow
p, role:default/team-lead, ghas-metrics, read, allow
p, role:default/developer, ghas-metrics, read, deny
p, role:default/viewer, ghas-metrics, read, deny
```

> Apenas Admin, Security Team, e Team Lead devem visualizar métricas organizacionais de segurança. O campo `push_protection_bypassed_by` contém logins de usuário e deve ser tratado como dado sensível — visível apenas para Admin e Security Team.
